use anchor_lang::prelude::*;
use groth16_solana::groth16::{Groth16Verifier, Groth16Verifyingkey};

// ============================================================================
// Verifying Keys (generated from circom circuits via convert_vk.js)
// ============================================================================

/// Task Verify VK: proves Poseidon(result) == expectedHash
/// Circuit has 1 public input: expectedHash
pub const TASK_VERIFY_VK: Groth16Verifyingkey = Groth16Verifyingkey {
    nr_pubinputs: 1,

    vk_alpha_g1: [
        38,19,44,130,112,116,240,152,213,139,150,1,38,90,193,90,96,81,200,187,237,58,174,185,229,216,180,164,37,111,192,189,
        43,202,179,4,92,16,26,148,244,139,135,137,218,136,228,229,73,70,66,124,207,198,253,170,93,41,210,168,54,123,125,4,
    ],

    vk_beta_g2: [
        4,161,213,94,47,152,25,108,19,182,163,167,50,186,86,251,228,56,217,122,182,133,130,197,168,93,200,68,0,217,18,79,
        46,197,213,239,33,12,207,187,14,65,64,111,32,65,206,11,1,51,112,48,208,233,89,150,53,164,103,65,217,60,39,85,
        17,198,44,5,142,102,94,130,246,180,205,137,28,93,169,68,196,3,73,153,11,110,118,13,170,88,136,238,30,137,229,132,
        1,125,59,108,163,70,115,1,210,209,54,157,213,66,205,234,96,165,133,34,210,202,5,11,131,149,101,129,121,179,157,63,
    ],

    vk_gamme_g2: [
        25,142,147,147,146,13,72,58,114,96,191,183,49,251,93,37,241,170,73,51,53,169,231,18,151,228,133,183,174,243,18,194,
        24,0,222,239,18,31,30,118,66,106,0,102,94,92,68,121,103,67,34,212,247,94,218,221,70,222,189,92,217,146,246,237,
        9,6,137,208,88,95,240,117,236,158,153,173,105,12,51,149,188,75,49,51,112,179,142,243,85,172,218,220,209,34,151,91,
        18,200,94,165,219,140,109,235,74,171,113,128,141,203,64,143,227,209,231,105,12,67,211,123,76,230,204,1,102,250,125,170,
    ],

    vk_delta_g2: [
        7,0,49,50,132,55,46,238,87,108,68,8,14,146,123,138,6,154,179,44,236,50,151,231,88,185,56,209,115,114,11,221,
        3,134,111,203,98,154,20,190,123,57,156,126,120,4,220,49,45,36,219,149,251,183,239,186,229,62,68,183,115,41,191,71,
        44,51,80,111,50,50,131,227,223,59,137,51,241,22,154,233,97,237,213,196,232,88,114,223,47,4,168,51,43,223,63,22,
        40,250,159,205,112,9,158,139,158,128,251,213,174,229,141,103,89,148,220,131,77,100,150,44,71,184,142,106,188,188,76,70,
    ],

    vk_ic: &[
        [
            46,226,24,142,64,164,234,219,59,91,214,185,203,238,5,129,198,128,125,213,124,211,151,148,182,158,30,148,184,208,220,178,
            14,250,232,216,15,50,86,210,238,61,92,80,131,238,24,245,211,50,1,204,142,160,102,159,249,29,185,22,109,7,123,111,
        ],
        [
            47,242,42,221,161,252,237,188,158,23,130,23,110,201,38,118,163,14,80,231,95,101,240,245,217,142,30,6,43,252,247,184,
            29,212,228,197,81,40,143,3,124,143,64,194,143,176,83,252,93,228,10,46,177,52,58,252,253,82,247,227,110,195,127,202,
        ],
    ]
};

/// Reputation VK: proves reputation >= threshold with identity binding
/// Circuit has 2 public inputs: threshold, providerCommitment
pub const REPUTATION_VK: Groth16Verifyingkey = Groth16Verifyingkey {
    nr_pubinputs: 2,

    vk_alpha_g1: [
        38,19,44,130,112,116,240,152,213,139,150,1,38,90,193,90,96,81,200,187,237,58,174,185,229,216,180,164,37,111,192,189,
        43,202,179,4,92,16,26,148,244,139,135,137,218,136,228,229,73,70,66,124,207,198,253,170,93,41,210,168,54,123,125,4,
    ],

    vk_beta_g2: [
        4,161,213,94,47,152,25,108,19,182,163,167,50,186,86,251,228,56,217,122,182,133,130,197,168,93,200,68,0,217,18,79,
        46,197,213,239,33,12,207,187,14,65,64,111,32,65,206,11,1,51,112,48,208,233,89,150,53,164,103,65,217,60,39,85,
        17,198,44,5,142,102,94,130,246,180,205,137,28,93,169,68,196,3,73,153,11,110,118,13,170,88,136,238,30,137,229,132,
        1,125,59,108,163,70,115,1,210,209,54,157,213,66,205,234,96,165,133,34,210,202,5,11,131,149,101,129,121,179,157,63,
    ],

    vk_gamme_g2: [
        25,142,147,147,146,13,72,58,114,96,191,183,49,251,93,37,241,170,73,51,53,169,231,18,151,228,133,183,174,243,18,194,
        24,0,222,239,18,31,30,118,66,106,0,102,94,92,68,121,103,67,34,212,247,94,218,221,70,222,189,92,217,146,246,237,
        9,6,137,208,88,95,240,117,236,158,153,173,105,12,51,149,188,75,49,51,112,179,142,243,85,172,218,220,209,34,151,91,
        18,200,94,165,219,140,109,235,74,171,113,128,141,203,64,143,227,209,231,105,12,67,211,123,76,230,204,1,102,250,125,170,
    ],

    vk_delta_g2: [
        4,67,30,108,4,83,24,192,41,216,174,233,68,65,240,145,191,169,229,252,100,129,45,50,40,133,214,192,11,150,61,74,
        47,36,16,121,208,176,56,17,236,88,39,220,64,16,27,220,216,185,72,54,113,150,27,32,76,96,135,104,38,149,234,200,
        35,74,171,37,179,123,180,246,13,78,188,155,99,189,101,102,198,161,14,69,41,7,249,79,147,241,83,240,72,68,216,201,
        4,39,79,68,2,12,237,50,121,109,229,120,13,130,121,55,230,242,214,35,37,185,188,97,119,226,113,166,98,78,81,43,
    ],

    vk_ic: &[
        [
            21,68,183,123,226,88,115,34,87,70,82,101,252,148,65,13,93,224,53,192,28,155,229,3,195,234,70,151,121,77,185,71,
            18,120,219,23,4,15,252,250,105,27,202,123,92,167,111,153,136,11,227,139,154,186,44,49,166,210,33,12,159,161,85,46,
        ],
        [
            14,171,238,104,187,202,30,193,40,235,106,32,73,169,116,107,241,157,63,53,127,5,249,56,114,155,173,27,96,35,44,4,
            39,139,18,154,223,156,246,62,53,113,75,187,122,216,55,61,130,185,170,228,165,17,149,248,162,181,28,81,157,166,83,156,
        ],
        [
            30,47,80,48,4,195,146,125,34,184,212,193,173,218,42,67,239,92,230,25,176,99,102,56,98,19,2,29,3,119,234,211,
            3,123,187,214,136,135,48,147,25,118,70,37,198,187,2,121,37,54,211,97,5,153,48,26,106,37,182,231,236,178,253,68,
        ],
    ]
};

// ============================================================================
// Verification helpers
// ============================================================================

/// Verify a Groth16 proof for the task_verify circuit.
/// proof_a: 64 bytes (G1 point, already negated and big-endian)
/// proof_b: 128 bytes (G2 point, big-endian)
/// proof_c: 64 bytes (G1 point, big-endian)
/// public_inputs: array of 32-byte big-endian field elements
pub fn verify_task_proof(
    proof_a: &[u8; 64],
    proof_b: &[u8; 128],
    proof_c: &[u8; 64],
    public_inputs: &[[u8; 32]; 1],
) -> Result<()> {
    let mut verifier = Groth16Verifier::new(
        proof_a,
        proof_b,
        proof_c,
        public_inputs,
        &TASK_VERIFY_VK,
    )
    .map_err(|_| error!(crate::errors::AgentPayError::ZkProofVerificationFailed))?;

    verifier
        .verify()
        .map_err(|_| error!(crate::errors::AgentPayError::ZkProofVerificationFailed))?;

    Ok(())
}

/// Verify a Groth16 proof for the reputation circuit.
pub fn verify_reputation_proof(
    proof_a: &[u8; 64],
    proof_b: &[u8; 128],
    proof_c: &[u8; 64],
    public_inputs: &[[u8; 32]; 2],
) -> Result<()> {
    let mut verifier = Groth16Verifier::new(
        proof_a,
        proof_b,
        proof_c,
        public_inputs,
        &REPUTATION_VK,
    )
    .map_err(|_| error!(crate::errors::AgentPayError::ZkProofVerificationFailed))?;

    verifier
        .verify()
        .map_err(|_| error!(crate::errors::AgentPayError::ZkProofVerificationFailed))?;

    Ok(())
}
